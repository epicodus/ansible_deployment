---
- name: php homebrew taps
  homebrew_tap: tap={{ item }}
  with_items:
    - "{{ php_homebrew_taps }}"

- name: install php dependencies
  homebrew: name={{ item.name }} install_options={{ item.options }}
  with_items:
    - "{{ php_homebrew_dependencies }}"

- name: start mysql server
  shell: mysql.server start

- name: set mysql root password
  shell: mysqladmin -u root password root
  ignore_errors: true

- name: stop mysql server
  shell: mysql.server stop

- name: copy config_inc_php
  copy: src=config_inc_php dest="/usr/local/share/phpmyadmin/config.inc.php"

- name: add apache2 http.conf content
  blockinfile:
    dest: /usr/local/etc/apache2/2.4/httpd.conf
    content: |
      AddType application/x-httpd-php .php
      DirectoryIndex index.html index.php
      <Directory "/">
          Require all granted
      </Directory>
      LoadModule expires_module libexec/mod_expires.so
      LoadModule deflate_module libexec/mod_deflate.so
      LoadModule rewrite_module libexec/mod_rewrite.so
      Alias /phpmyadmin /usr/local/share/phpmyadmin
      <Directory /usr/local/share/phpmyadmin/>
        Options Indexes FollowSymLinks MultiViews
        AllowOverride All
        <IfModule mod_authz_core.c>
          Require all granted
        </IfModule>
        <IfModule !mod_authz_core.c>
          Order allow,deny
          Allow from all
        </IfModule>
      </Directory>
      ServerName localhost

# STUDENTS
- name: copy MAMP preferences plist for Guest
  copy: src=de.appsolute.MAMP.plist dest="{{ guest_path }}/Library/Preferences/de.appsolute.MAMP.plist"
  become: yes
  when: "'students' in group_names"

- name: check if drush is installed for Guest
  stat: path="{{ guest_path }}/.composer/vendor/drush"
  register: drush_installed_guest
  when: "'students' in group_names"
  environment:
    COMPOSER_HOME: "{{ guest_path }}/.composer"

- name: install drush for Guest
  shell: /usr/local/bin/composer global require drush/drush:7.* -n --prefer-source
  when: "'students' in group_names and drush_installed_guest.stat.exists == false"
  environment:
    COMPOSER_HOME: "{{ guest_path }}/.composer"

- name: set Guest permission for /Applications/MAMP
  file: path=/Applications/MAMP owner=Guest recurse=yes
  become: yes
  when: "'students' in group_names"
# STUDENTS

# STAFF
- name: copy MAMP preferences plist for staff
  copy: src=de.appsolute.MAMP.plist dest="{{ staff_path }}/Library/Preferences/de.appsolute.MAMP.plist"
  become: yes
  when: "'staff' in group_names"

- name: check if drush is installed for staff
  stat: path="{{ staff_path }}/.composer/vendor/drush"
  register: drush_installed_staff
  when: "'staff' in group_names"
  environment:
    COMPOSER_HOME: "{{ staff_path }}/.composer"

- name: install drush for staff
  shell: /usr/local/bin/composer global require drush/drush:7.* -n --prefer-source
  when: "'staff' in group_names and drush_installed_staff.stat.exists == false"
  environment:
    COMPOSER_HOME: "{{ staff_path }}/.composer"

- name: set staff permission for /Applications/MAMP
  file: path=/Applications/MAMP owner=epicodus_staff recurse=yes
  become: yes
  when: "'staff' in group_names"
# STAFF
